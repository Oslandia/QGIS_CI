# SonarCloud
image: qgis/qgis3-build-deps:latest

variables:
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
  GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task

get-sonar-binaries:
  stage: .pre
  cache:
    policy: push
    key: "${CI_COMMIT_SHORT_SHA}"
    paths:
      - build-wrapper/
      - sonar-scanner/
  script:
    # Download sonar-scanner
    - curl -sSLo ./sonar-scanner.zip 'https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.4.0.2170-linux.zip'
    - unzip -o sonar-scanner.zip
    - mv sonar-scanner-4.4.0.2170-linux sonar-scanner
    # Download build-wrapper
    - curl -sSLo ./build-wrapper-linux-x86.zip "${SONAR_HOST_URL}/static/cpp/build-wrapper-linux-x86.zip"
    - unzip -oj build-wrapper-linux-x86.zip -d ./build-wrapper
  only:
    - merge_requests
    - master
    - develop

build:
  stage: build
  cache:
    policy: pull-push
    key: "${CI_COMMIT_SHORT_SHA}"
    paths:
      - build-wrapper/
      - sonar-scanner/
      - bw-output/
      - build/ # the build has to be made available to the sonar-scanner for the analysis
  script:
    # prepare the build tree
    - mkdir build
    - cmake -S . -B build -DCMAKE_BUILD_TYPE=Debug \
	  -DWITH_DESKTOP=ON \
	  -DWITH_SERVER=ON \
	  -DWITH_3D=ON \
	  -DWITH_BINDINGS=ON \
	  -DWITH_CUSTOM_WIDGETS=ON \
	  -DBINDINGS_GLOBAL_INSTALL=ON \
	  -DWITH_STAGED_PLUGINS=ON \
	  -DWITH_GRASS=ON \
	  -DSUPPRESS_QT_WARNINGS=ON \
	  -DDISABLE_DEPRECATED=ON \
	  -DENABLE_TESTS=OFF \
	  -DWITH_QSPATIALITE=ON \
	  -DWITH_APIDOC=OFF \
	  -DWITH_ASTYLE=OFF \
	  -DQT5_3DEXTRA_LIBRARY="/usr/lib/x86_64-linux-gnu/libQt53DExtras.so" \
	  -DQT5_3DEXTRA_INCLUDE_DIR="/QGIS/external/qt3dextra-headers" \
	  -DQt53DExtras_DIR="/QGIS/external/qt3dextra-headers/cmake/Qt53DExtras" \
	  -DCMAKE_PREFIX_PATH="/QGIS/external/qt3dextra-headers"
    # run the build inside the build wrapper
    - build-wrapper/build-wrapper-linux-x86-64 --out-dir bw-output cmake --build build/ --config Debug
  artifacts:
    paths:
      - build/
  only:
    - merge_requests
    - master
    - develop

sonarcloud-check:
  stage: .post
  cache:
    policy: pull
    key: "${CI_COMMIT_SHORT_SHA}"
    paths:
      - build-wrapper/
      - sonar-scanner/
      - bw-output/
      - build/
  script:
    - sonar-scanner/bin/sonar-scanner -Dsonar.host.url="${SONAR_HOST_URL}" -Dsonar.token="${SONAR_TOKEN}" -Dsonar.cfamily.build-wrapper-output=bw-output
  only:
    - merge_requests
    - master
    - develop
